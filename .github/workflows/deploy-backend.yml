name: Deploy Backend to Vercel

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ] || [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "❌ Error: VERCEL_PROJECT_ID or VERCEL_ORG_ID is not set in GitHub Secrets"
            echo "Please configure the following secrets:"
            echo "  VERCEL_PROJECT_ID: prj_qLSTYFjRO9WqbuZnEKt0XzRaPzwR"
            echo "  VERCEL_ORG_ID: team_KiKcsNJDyqr8Ah4GFD9n0yun"
            exit 1
          fi
          echo "✅ Secrets verified"

      - name: Create Vercel Project Config
        run: |
          mkdir -p .vercel
          # Use hardcoded values as fallback to prevent accidental project creation
          PROJECT_ID="${{ secrets.VERCEL_PROJECT_ID }}"
          ORG_ID="${{ secrets.VERCEL_ORG_ID }}"

          # Fallback to hardcoded values if secrets are empty
          if [ -z "$PROJECT_ID" ]; then
            PROJECT_ID="prj_qLSTYFjRO9WqbuZnEKt0XzRaPzwR"
            echo "⚠️  Warning: Using hardcoded VERCEL_PROJECT_ID"
          fi

          if [ -z "$ORG_ID" ]; then
            ORG_ID="team_KiKcsNJDyqr8Ah4GFD9n0yun"
            echo "⚠️  Warning: Using hardcoded VERCEL_ORG_ID"
          fi

          echo "{\"projectId\":\"$PROJECT_ID\",\"orgId\":\"$ORG_ID\"}" > .vercel/project.json
          cat .vercel/project.json
          echo "✅ Created .vercel/project.json"
        working-directory: ./backend

      - name: Deploy to Vercel
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./backend
