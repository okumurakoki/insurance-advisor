# LINEé€šçŸ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰

## æ¦‚è¦
ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€LINEé€šçŸ¥æ©Ÿèƒ½ã®3ã¤ã®ä¸»è¦æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆæ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ï¼š
1. **ãƒ¯ãƒ³ã‚¦ã‚§ã‚¤é€šçŸ¥é…ä¿¡** - ãƒ¬ãƒãƒ¼ãƒˆå®Œæˆæ™‚ã®è‡ªå‹•é€šçŸ¥
2. **ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯** - LINE â†’ Webã‚¢ãƒ—ãƒªã¸ã®ç›´æ¥é·ç§»
3. **è‡ªå‹•è¿”ä¿¡** - åŸºæœ¬çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”

## å‰ææ¡ä»¶

### å¿…è¦ãªç’°å¢ƒå¤‰æ•°
`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼š
```bash
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
LINE_CHANNEL_SECRET=your_channel_secret
FRONTEND_URL=https://prudential-insurance-optimizer.vercel.app
```

### å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«
- `customers` - LINEé€£æºæ¸ˆã¿ã®é¡§å®¢æƒ…å ±
- `analysis_results` - åˆ†æãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
- `line_link_tokens` - QRé€£æºç”¨ãƒˆãƒ¼ã‚¯ãƒ³

---

## 1. æ‰‹å‹•é€šçŸ¥ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
```
POST /api/line/send-report-notification
```

### èªè¨¼
- Bearerãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ï¼ˆstaffã¾ãŸã¯agencyã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
- æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šè‡ªåˆ†ã®é¡§å®¢ã®ã¿é€šçŸ¥å¯èƒ½

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆcurlï¼‰
```bash
# ã¾ãšèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
curl -X POST https://prudential-insurance-optimizer-qfn0i3jfh-kokiokumuras-projects.vercel.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "staff@example.com",
    "password": "your_password"
  }'

# å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦é€šçŸ¥é€ä¿¡
curl -X POST https://prudential-insurance-optimizer-qfn0i3jfh-kokiokumuras-projects.vercel.app/api/line/send-report-notification \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "customerId": "customer_uuid_here",
    "analysisId": "analysis_uuid_here"
  }'
```

### Postmanã§ã®ãƒ†ã‚¹ãƒˆ
1. **ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‘¼ã³å‡ºã—**
   - Method: `POST`
   - URL: `{{baseUrl}}/api/auth/login`
   - Body (JSON):
     ```json
     {
       "email": "staff@example.com",
       "password": "password123"
     }
     ```
   - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰`accessToken`ã‚’ä¿å­˜

2. **é€šçŸ¥é€ä¿¡**
   - Method: `POST`
   - URL: `{{baseUrl}}/api/line/send-report-notification`
   - Headers:
     - `Authorization`: `Bearer {{accessToken}}`
     - `Content-Type`: `application/json`
   - Body (JSON):
     ```json
     {
       "customerId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
       "analysisId": "a3bb189e-8bf9-3888-9912-ace4e6543002"
     }
     ```

### æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ
1. **æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ200 OKï¼‰**
   ```json
   {
     "success": true,
     "message": "LINE notification sent successfully",
     "sentTo": "å±±ç”°å¤ªéƒ"
   }
   ```

2. **LINEå´ã®å—ä¿¡**
   - é¡§å®¢ã®LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«Flex MessageãŒå±Šã
   - ãƒ˜ãƒƒãƒ€ãƒ¼: ã€Œâœ¨ é‹ç”¨åˆ†æãƒ¬ãƒãƒ¼ãƒˆå®Œæˆã€
   - æœ¬æ–‡: é¡§å®¢åã€æ¨å¥¨è³‡ç”£é…åˆ†ã€å¸‚å ´åˆ†ææ¦‚è¦ã€ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢
   - ãƒ•ãƒƒã‚¿ãƒ¼: ã€Œè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ï¼‰

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ

#### 1. LINEæœªé€£æºã®é¡§å®¢
```bash
# LINEé€£æºã—ã¦ã„ãªã„é¡§å®¢IDã§å®Ÿè¡Œ
curl -X POST {{baseUrl}}/api/line/send-report-notification \
  -H "Authorization: Bearer {{token}}" \
  -H "Content-Type: application/json" \
  -d '{"customerId": "unlinked_customer_id", "analysisId": "analysis_id"}'
```
**æœŸå¾…ã•ã‚Œã‚‹çµæœï¼ˆ400 Bad Requestï¼‰:**
```json
{
  "error": "Customer does not have LINE linked",
  "message": "ã“ã®é¡§å®¢ã¯LINEé€£æºã—ã¦ã„ã¾ã›ã‚“"
}
```

#### 2. æ¨©é™ãªã—
```bash
# ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã®é¡§å®¢ã«é€šçŸ¥é€ä¿¡ã‚’è©¦ã¿ã‚‹
```
**æœŸå¾…ã•ã‚Œã‚‹çµæœï¼ˆ403 Forbiddenï¼‰:**
```json
{
  "error": "Permission denied"
}
```

#### 3. å­˜åœ¨ã—ãªã„åˆ†æID
```bash
curl -X POST {{baseUrl}}/api/line/send-report-notification \
  -H "Authorization: Bearer {{token}}" \
  -H "Content-Type: application/json" \
  -d '{"customerId": "valid_id", "analysisId": "non_existent_id"}'
```
**æœŸå¾…ã•ã‚Œã‚‹çµæœï¼ˆ404 Not Foundï¼‰:**
```json
{
  "error": "Analysis result not found"
}
```

---

## 2. è‡ªå‹•é€šçŸ¥ï¼ˆåˆ†æå®Œäº†æ™‚ï¼‰ã®ãƒ†ã‚¹ãƒˆ

### ãƒˆãƒªã‚¬ãƒ¼
åˆ†æAPIå®Œäº†æ™‚ã«è‡ªå‹•çš„ã«LINEé€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. **LINEé€£æºæ¸ˆã¿é¡§å®¢ã§åˆ†æã‚’å®Ÿè¡Œ**
   ```bash
   curl -X POST {{baseUrl}}/api/analysis \
     -H "Authorization: Bearer {{token}}" \
     -H "Content-Type: application/json" \
     -d '{
       "customerId": "line_linked_customer_id",
       "analysisType": "portfolio_optimization"
     }'
   ```

2. **åˆ†æå®Œäº†ã‚’å¾…ã¤**
   - åˆ†æå‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¨è‡ªå‹•çš„ã«LINEé€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹
   - ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª:
     ```
     [INFO] Analysis created: analysis_id_here
     [INFO] LINE notification sent to customer: å±±ç”°å¤ªéƒ
     ```

3. **LINEå´ã§ç¢ºèª**
   - é¡§å®¢ã®LINEã«è‡ªå‹•çš„ã«ãƒ¬ãƒãƒ¼ãƒˆé€šçŸ¥ãŒå±Šã
   - é€šçŸ¥å†…å®¹ã¯æ‰‹å‹•é€šçŸ¥ã¨åŒã˜Flex Messageå½¢å¼

### æ³¨æ„äº‹é …
- LINEé€šçŸ¥ã®å¤±æ•—ã¯åˆ†æå‡¦ç†å…¨ä½“ã‚’å¦¨ã’ãªã„ï¼ˆéãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
- LINEé€šçŸ¥å¤±æ•—æ™‚ã‚‚analysis_resultsã«ã¯æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã‚‹
- ã‚¨ãƒ©ãƒ¼ã¯ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹ï¼š
  ```
  [ERROR] Failed to send LINE notification: {error details}
  ```

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

#### ã‚·ãƒŠãƒªã‚ª1: LINEé€£æºæ¸ˆã¿é¡§å®¢
1. LINEé€£æºæ¸ˆã¿ã®é¡§å®¢ã‚’é¸æŠ
2. åˆ†æã‚’å®Ÿè¡Œ
3. **æœŸå¾…çµæœ**: åˆ†æå®Œäº†å¾Œã€LINEã«è‡ªå‹•é€šçŸ¥ãŒå±Šã

#### ã‚·ãƒŠãƒªã‚ª2: LINEæœªé€£æºã®é¡§å®¢
1. LINEæœªé€£æºã®é¡§å®¢ã‚’é¸æŠ
2. åˆ†æã‚’å®Ÿè¡Œ
3. **æœŸå¾…çµæœ**: åˆ†æã¯æ­£å¸¸å®Œäº†ã™ã‚‹ãŒã€LINEé€šçŸ¥ã¯é€ä¿¡ã•ã‚Œãªã„ï¼ˆãƒ­ã‚°ã«ã‚¹ã‚­ãƒƒãƒ—ãŒè¨˜éŒ²ã•ã‚Œã‚‹ï¼‰

---

## 3. ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã®ãƒ†ã‚¹ãƒˆ

### ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã®ä»•æ§˜
LINEé€šçŸ¥ã‹ã‚‰Webã‚¢ãƒ—ãƒªã®ç‰¹å®šãƒšãƒ¼ã‚¸ã¸ç›´æ¥é·ç§»ã§ãã‚‹æ©Ÿèƒ½ã€‚

### URLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
```
${FRONTEND_URL}/customers/${customerId}/analysis/${analysisId}
```

ä¾‹:
```
https://prudential-insurance-optimizer.vercel.app/customers/f47ac10b-58cc-4372-a567-0e02b2c3d479/analysis/a3bb189e-8bf9-3888-9912-ace4e6543002
```

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. **LINEé€šçŸ¥ã‚’å—ä¿¡**
   - æ‰‹å‹•ã¾ãŸã¯è‡ªå‹•é€šçŸ¥ã§ãƒ¬ãƒãƒ¼ãƒˆé€šçŸ¥ã‚’å—ã‘å–ã‚‹

2. **ã€Œè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—**
   - Flex Messageã®ãƒ•ãƒƒã‚¿ãƒ¼ã«ã‚ã‚‹ãƒ—ãƒ©ã‚¤ãƒãƒªãƒœã‚¿ãƒ³

3. **æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**
   - ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãï¼ˆã¾ãŸã¯WebViewï¼‰
   - è©²å½“ã™ã‚‹åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®è©³ç´°ãƒšãƒ¼ã‚¸ã«ç›´æ¥é·ç§»
   - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: `customerId`ã¨`analysisId`ãŒæ­£ã—ãå«ã¾ã‚Œã‚‹

4. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ç¢ºèª**
   - é¡§å®¢æƒ…å ±ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
   - åˆ†æãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
   - ã‚°ãƒ©ãƒ•ã€æ¨å¥¨é…åˆ†ã€å¸‚å ´åˆ†æãªã©ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã®ãƒ‡ãƒãƒƒã‚°

#### URLã®ç¢ºèªæ–¹æ³•
LINEé€šçŸ¥ã®JSONæ§‹é€ ã‚’ç¢ºèªï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã¾ãŸã¯LINE Developers Consoleï¼‰:
```json
{
  "type": "flex",
  "contents": {
    "footer": {
      "contents": [{
        "type": "button",
        "action": {
          "type": "uri",
          "label": "è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹",
          "uri": "https://prudential-insurance-optimizer.vercel.app/customers/xxx/analysis/yyy"
        }
      }]
    }
  }
}
```

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | URL | æœŸå¾…ã•ã‚Œã‚‹çµæœ |
|------------|-----|--------------|
| æ­£å¸¸ãªID | `/customers/{valid_id}/analysis/{valid_id}` | ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| å­˜åœ¨ã—ãªã„customerId | `/customers/{invalid}/analysis/{valid_id}` | 404ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| å­˜åœ¨ã—ãªã„analysisId | `/customers/{valid_id}/analysis/{invalid}` | 404ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| æ¨©é™ãªã— | ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã®é¡§å®¢ | 403ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ |

---

## 4. è‡ªå‹•è¿”ä¿¡æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ

### ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰ | ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ | æ©Ÿèƒ½ |
|---------|-------------|------|
| ãƒ¬ãƒãƒ¼ãƒˆ | report | æœ€æ–°ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ |
| å•ã„åˆã‚ã› | å•åˆã›ã€contactã€ãŠå•ã„åˆã‚ã› | æ‹…å½“è€…æƒ…å ±ã‚’è¡¨ç¤º |
| ãƒ˜ãƒ«ãƒ— | helpã€ä½¿ã„æ–¹ã€ã¤ã‹ã„ã‹ãŸ | ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | status | é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

#### äº‹å‰æº–å‚™
1. LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ 
2. 6æ¡ã®èªè¨¼ã‚³ãƒ¼ãƒ‰ã§é¡§å®¢ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é€£æºå®Œäº†
3. å°‘ãªãã¨ã‚‚1ã¤ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹çŠ¶æ…‹

#### 1. ã€Œãƒ¬ãƒãƒ¼ãƒˆã€ã‚³ãƒãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ

**å…¥åŠ›:**
```
ãƒ¬ãƒãƒ¼ãƒˆ
```
ã¾ãŸã¯
```
report
```

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:**
- æœ€æ–°ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒFlex Messageã§é€ä¿¡ã•ã‚Œã‚‹
- å†…å®¹: æ¨å¥¨è³‡ç”£é…åˆ†ã€å¸‚å ´åˆ†ææ¦‚è¦ã€ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢
- ã€Œè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹

**ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: ãƒ¬ãƒãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆ**
```
ã¾ã åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚

æ‹…å½“è€…ã«åˆ†æã®å®Ÿæ–½ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚
```

#### 2. ã€Œå•ã„åˆã‚ã›ã€ã‚³ãƒãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ

**å…¥åŠ›:**
```
å•ã„åˆã‚ã›
```
ã¾ãŸã¯
```
contact
```

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:**
- æ‹…å½“è€…æƒ…å ±ã®Flex MessageãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ãƒ˜ãƒƒãƒ€ãƒ¼: ğŸ“ ãŠå•ã„åˆã‚ã›
- æœ¬æ–‡:
  - ã€Œ{é¡§å®¢å}æ§˜ã®æ‹…å½“è€…ã€
  - ã€ŒãŠæ°—è»½ã«LINEã§ã”é€£çµ¡ãã ã•ã„ã€‚ã€
  - å–¶æ¥­æ™‚é–“: å¹³æ—¥ 9:00-18:00

#### 3. ã€Œãƒ˜ãƒ«ãƒ—ã€ã‚³ãƒãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ

**å…¥åŠ›:**
```
ãƒ˜ãƒ«ãƒ—
```
ã¾ãŸã¯
```
help
```

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:**
- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã®Flex MessageãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ãƒ˜ãƒƒãƒ€ãƒ¼: ğŸ’¡ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰
- æœ¬æ–‡: åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
  - ğŸ“Š ã€Œãƒ¬ãƒãƒ¼ãƒˆã€â†’ æœ€æ–°ã®é‹ç”¨åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
  - ğŸ’¬ ã€Œå•ã„åˆã‚ã›ã€â†’ æ‹…å½“è€…ã¸ã®é€£çµ¡æ–¹æ³•
  - â“ ã€Œãƒ˜ãƒ«ãƒ—ã€â†’ ã“ã®ã‚¬ã‚¤ãƒ‰è¡¨ç¤º

#### 4. ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚³ãƒãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ

**å…¥åŠ›:**
```
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
```
ã¾ãŸã¯
```
status
```

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:**
- é¡§å®¢æƒ…å ±ã®Flex MessageãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ãƒ˜ãƒƒãƒ€ãƒ¼: ğŸ“‹ ãŠå®¢æ§˜æƒ…å ±
- æœ¬æ–‡:
  - ãŠåå‰: {é¡§å®¢å}
  - ãƒªã‚¹ã‚¯è¨±å®¹åº¦: ä¿å®ˆçš„/ãƒãƒ©ãƒ³ã‚¹å‹/ç©æ¥µçš„
  - ä¿é™ºä¼šç¤¾: {ä¿é™ºä¼šç¤¾å}

#### 5. æœªå¯¾å¿œã‚³ãƒãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ

**å…¥åŠ›:**
```
ã“ã‚“ã«ã¡ã¯
```
ã¾ãŸã¯ä»»æ„ã®ãƒ†ã‚­ã‚¹ãƒˆ

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:**
```
ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„ï¼š
ğŸ“Š ã€Œãƒ¬ãƒãƒ¼ãƒˆã€
ğŸ’¬ ã€Œå•ã„åˆã‚ã›ã€
â“ ã€Œãƒ˜ãƒ«ãƒ—ã€
```

#### 6. èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰é€ä¿¡ã®ãƒ†ã‚¹ãƒˆ

**å…¥åŠ›:**
```
ABC123
```
ï¼ˆæœ‰åŠ¹ãªèªè¨¼ã‚³ãƒ¼ãƒ‰ï¼‰

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:**
- LINEé€£æºãŒå®Œäº†
- é€£æºå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆFlex Messageï¼‰
- âœ… é€£æºå®Œäº†
- åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## 5. ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª1: æ–°è¦é¡§å®¢ã®ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

1. **ã‚¹ã‚¿ãƒƒãƒ•å´: QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ**
   ```bash
   POST /api/line/generate-qr
   Body: { "customerId": "new_customer_id" }
   ```

2. **é¡§å®¢å´: å‹ã ã¡è¿½åŠ **
   - QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
   - LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ 
   - ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡

3. **é¡§å®¢å´: èªè¨¼ã‚³ãƒ¼ãƒ‰é€ä¿¡**
   - ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰æç¤ºã•ã‚ŒãŸ6æ¡ã‚³ãƒ¼ãƒ‰ã‚’LINEã§é€ä¿¡
   - ä¾‹: `ABC123`
   - é€£æºå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡

4. **é¡§å®¢å´: ãƒ˜ãƒ«ãƒ—ç¢ºèª**
   - ã€Œãƒ˜ãƒ«ãƒ—ã€ã¨é€ä¿¡
   - ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’ç¢ºèª

5. **ã‚¹ã‚¿ãƒƒãƒ•å´: åˆ†æå®Ÿè¡Œ**
   ```bash
   POST /api/analysis
   Body: { "customerId": "new_customer_id" }
   ```

6. **é¡§å®¢å´: è‡ªå‹•é€šçŸ¥å—ä¿¡**
   - åˆ†æå®Œäº†å¾Œã€è‡ªå‹•çš„ã«ãƒ¬ãƒãƒ¼ãƒˆé€šçŸ¥ã‚’å—ä¿¡
   - ã€Œè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—
   - Webã‚¢ãƒ—ãƒªã§è©³ç´°ã‚’ç¢ºèª

### ã‚·ãƒŠãƒªã‚ª2: æ—¢å­˜é¡§å®¢ã®ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª

1. **é¡§å®¢å´: ãƒ¬ãƒãƒ¼ãƒˆè¦æ±‚**
   - LINEã§ã€Œãƒ¬ãƒãƒ¼ãƒˆã€ã¨é€ä¿¡

2. **ã‚·ã‚¹ãƒ†ãƒ : æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡**
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€æ–°ã®analysis_resultsã‚’å–å¾—
   - Flex Messageã§é€ä¿¡

3. **é¡§å®¢å´: è©³ç´°ç¢ºèª**
   - ã€Œè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹ã€ã‚’ã‚¿ãƒƒãƒ—
   - Webãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯çµŒç”±ã§è©³ç´°ãƒšãƒ¼ã‚¸ã¸é·ç§»

4. **é¡§å®¢å´: å•ã„åˆã‚ã›**
   - è³ªå•ãŒã‚ã‚Œã°ã€Œå•ã„åˆã‚ã›ã€ã¨é€ä¿¡
   - æ‹…å½“è€…æƒ…å ±ã‚’ç¢ºèª
   - ãã®ã¾ã¾LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å´ã§å¯¾å¿œï¼‰

---

## 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### LINEé€šçŸ¥ãŒå±Šã‹ãªã„

#### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
1. **LINEé€£æºç¢ºèª**
   ```sql
   SELECT id, name, line_user_id, line_display_name
   FROM customers
   WHERE id = 'customer_id';
   ```
   - `line_user_id`ãŒNULLã§ãªã„ã‹ç¢ºèª

2. **ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª**
   ```bash
   echo $LINE_CHANNEL_ACCESS_TOKEN
   ```
   - ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

3. **LINE Developers Consoleç¢ºèª**
   - Messaging APIè¨­å®šãŒæœ‰åŠ¹ã‹
   - WebhookãŒæœ‰åŠ¹ã‹
   - ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹æœŸé™å†…ã‹

4. **ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ç¢ºèª**
   ```bash
   # Vercelãƒ­ã‚°ç¢ºèª
   vercel logs --prod
   ```
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
   - `Failed to send LINE message`ã§æ¤œç´¢

### ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ãŒå‹•ä½œã—ãªã„

1. **FRONTEND_URLç’°å¢ƒå¤‰æ•°ç¢ºèª**
   ```bash
   # .envãƒ•ã‚¡ã‚¤ãƒ«
   FRONTEND_URL=https://prudential-insurance-optimizer.vercel.app
   ```

2. **URLç”Ÿæˆç¢ºèª**
   - ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§URLã‚’ç¢ºèª
   - `line.service.js:80`ä»˜è¿‘ã®ãƒ­ã‚°

3. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç¢ºèª**
   - `/customers/:customerId/analysis/:analysisId`ãƒ«ãƒ¼ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹
   - èªè¨¼ãŒå¿…è¦ãªå ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‹

### è‡ªå‹•è¿”ä¿¡ãŒå‹•ä½œã—ãªã„

1. **Webhookè¨­å®šç¢ºèª**
   ```bash
   # LINE Developers Console > Messaging API
   # Webhook URL: https://your-domain.vercel.app/api/line/webhook
   # Webhookæœ‰åŠ¹åŒ–: ON
   ```

2. **ç½²åæ¤œè¨¼ç¢ºèª**
   - LINE_CHANNEL_SECRETãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
   - Webhookç½²åæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒãƒ­ã‚°ã«ãªã„ã‹

3. **é¡§å®¢é€£æºç¢ºèª**
   - é¡§å®¢ãŒLINEé€£æºæ¸ˆã¿ã‹
   - `customers.line_user_id`ã«LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹

---

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### è² è·ãƒ†ã‚¹ãƒˆ: åŒæ™‚é€šçŸ¥é€ä¿¡

```bash
# Apache Benchã‚’ä½¿ç”¨ã—ã¦100ä»¶ã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
ab -n 100 -c 10 -H "Authorization: Bearer ${TOKEN}" \
   -H "Content-Type: application/json" \
   -p notification_payload.json \
   https://prudential-insurance-optimizer-qfn0i3jfh-kokiokumuras-projects.vercel.app/api/line/send-report-notification
```

**notification_payload.json:**
```json
{
  "customerId": "test_customer_id",
  "analysisId": "test_analysis_id"
}
```

### æœŸå¾…ã•ã‚Œã‚‹çµæœ
- ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ30ç§’ä»¥å†…ã«å®Œäº†ï¼ˆVercel Functionåˆ¶é™ï¼‰
- ã‚¨ãƒ©ãƒ¼ç‡ < 1%
- LINE API rate limitã«é”ã—ãªã„ã“ã¨

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

### 1. èªè¨¼ãƒ†ã‚¹ãƒˆ
```bash
# ãƒˆãƒ¼ã‚¯ãƒ³ãªã—ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
curl -X POST {{baseUrl}}/api/line/send-report-notification \
  -H "Content-Type: application/json" \
  -d '{"customerId": "xxx", "analysisId": "yyy"}'
```
**æœŸå¾…çµæœ**: 401 Unauthorized

### 2. æ¨©é™ãƒ†ã‚¹ãƒˆ
```bash
# ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã®é¡§å®¢ã«é€šçŸ¥é€ä¿¡
# Staff A ã®ãƒˆãƒ¼ã‚¯ãƒ³ã§ Staff B ã®é¡§å®¢ã«é€ä¿¡
```
**æœŸå¾…çµæœ**: 403 Forbidden

### 3. å…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
```bash
# ç„¡åŠ¹ãªUUIDå½¢å¼
curl -X POST {{baseUrl}}/api/line/send-report-notification \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"customerId": "invalid-id", "analysisId": "invalid-id"}'
```
**æœŸå¾…çµæœ**: 400 Bad Request

### 4. Webhookç½²åæ¤œè¨¼ãƒ†ã‚¹ãƒˆ
```bash
# ç„¡åŠ¹ãªç½²åã§Webhookã‚’é€ä¿¡
curl -X POST {{baseUrl}}/api/line/webhook \
  -H "X-Line-Signature: invalid_signature" \
  -H "Content-Type: application/json" \
  -d '{"events": []}'
```
**æœŸå¾…çµæœ**: 401 Signature verification failed

---

## ã¾ã¨ã‚

### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] **1. ãƒ¯ãƒ³ã‚¦ã‚§ã‚¤é€šçŸ¥é…ä¿¡**
  - [x] æ‰‹å‹•é€šçŸ¥ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (`POST /api/line/send-report-notification`)
  - [x] åˆ†æå®Œäº†æ™‚ã®è‡ªå‹•é€šçŸ¥
  - [x] Flex Messageã«ã‚ˆã‚‹ãƒªãƒƒãƒã‚«ãƒ¼ãƒ‰è¡¨ç¤º
  - [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆéãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰

- [x] **2. ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯**
  - [x] URLç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (`${FRONTEND_URL}/customers/${customerId}/analysis/${analysisId}`)
  - [x] Flex Messageå†…ã«ãƒœã‚¿ãƒ³ã¨ã—ã¦é…ç½®
  - [x] LINE â†’ Webã‚¢ãƒ—ãƒªã¸ã®ç›´æ¥é·ç§»

- [x] **3. è‡ªå‹•è¿”ä¿¡æ©Ÿèƒ½**
  - [x] ã€Œãƒ¬ãƒãƒ¼ãƒˆã€ã‚³ãƒãƒ³ãƒ‰ - æœ€æ–°åˆ†æãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
  - [x] ã€Œå•ã„åˆã‚ã›ã€ã‚³ãƒãƒ³ãƒ‰ - æ‹…å½“è€…æƒ…å ±è¡¨ç¤º
  - [x] ã€Œãƒ˜ãƒ«ãƒ—ã€ã‚³ãƒãƒ³ãƒ‰ - ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
  - [x] ã€Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ã‚³ãƒãƒ³ãƒ‰ - é¡§å®¢æƒ…å ±è¡¨ç¤º
  - [x] èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰ã«ã‚ˆã‚‹è‡ªå‹•é€£æº
  - [x] æœªå¯¾å¿œã‚³ãƒãƒ³ãƒ‰ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”

### ãƒ†ã‚¹ãƒˆæ¨å¥¨é †åº

1. **åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ**
   - LINEé€£æºï¼ˆQRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ â†’ å‹ã ã¡è¿½åŠ  â†’ èªè¨¼ã‚³ãƒ¼ãƒ‰é€ä¿¡ï¼‰
   - æ‰‹å‹•é€šçŸ¥é€ä¿¡
   - è‡ªå‹•è¿”ä¿¡ï¼ˆãƒ˜ãƒ«ãƒ—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰

2. **çµ±åˆãƒ†ã‚¹ãƒˆ**
   - åˆ†æå®Ÿè¡Œ â†’ è‡ªå‹•é€šçŸ¥ â†’ ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯é·ç§»
   - ãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ â†’ æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º â†’ ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯

3. **ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ**
   - LINEæœªé€£æºé¡§å®¢ã¸ã®é€šçŸ¥
   - ç„¡åŠ¹ãªèªè¨¼ã‚³ãƒ¼ãƒ‰
   - æ¨©é™ã®ãªã„é¡§å®¢ã¸ã®æ“ä½œ

4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**
   - åŒæ™‚é€šçŸ¥é€ä¿¡
   - å¤§é‡ã®è‡ªå‹•è¿”ä¿¡å‡¦ç†

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å¯¾å¿œç¢ºèª**
   - `/customers/:customerId/analysis/:analysisId`ãƒ«ãƒ¼ãƒˆã®å®Ÿè£…ç¢ºèª
   - èªè¨¼çŠ¶æ…‹ã§ã®æ­£ã—ã„ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

2. **æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèª**
   - å®Ÿéš›ã®LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
   - é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸå®Ÿé‹ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

3. **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š**
   - LINEé€šçŸ¥æˆåŠŸç‡ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
   - ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
   - ä½¿ç”¨çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ
